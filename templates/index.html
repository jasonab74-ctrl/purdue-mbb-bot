<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Purdue Men's Basketball — Feed</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <meta name="color-scheme" content="dark light">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <h1>Purdue Men's Basketball</h1>
      <div class="updated">Updated: <span id="updatedText">{{ updated or "—" }}</span></div>
    </div>
    <button id="refreshBtn" class="btn">Check for updates</button>
  </header>

  <nav class="pills">
    {% for link in static_links %}
      <a class="pill" href="{{link.url}}" target="_blank" rel="noopener">{{link.label}}</a>
    {% endfor %}
  </nav>

  <section class="sources-wrap">
    <details>
      <summary>Sources</summary>
      <ul class="sources">
        {% for s in sources %}
          <li><a href="{{s.url}}" target="_blank" rel="noopener">{{s.name}}</a></li>
        {% endfor %}
      </ul>
    </details>
  </section>

  <main id="feed">
    {% if items and items|length > 0 %}
      {% for it in items %}
        <article class="card">
          <div class="card-top">
            <span class="src">{{ it.source }}</span>
            <time class="time"
                  data-iso="{{ it.published or '' }}">{{ it.published[:16].replace('T',' ') if it.published }}</time>
          </div>

          <h3 class="title">
            <a class="title-link" href="{{ it.link }}" target="_blank" rel="noopener">
              {{ it.title }}
            </a>
          </h3>

          {% if it.summary %}
            <p class="summary">{{ it.summary|striptags }}</p>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="empty">No items yet.</p>
      <div class="actions">
        <button id="collectNow" class="btn btn-ghost">Collect now</button>
      </div>
    {% endif %}
  </main>

  <footer class="site-footer">
    <span>Auto-refreshes every 3 minutes</span>
  </footer>

  <script>
    // Friendly time labels like "Sep 4 • 3:40 PM"
    function fmt(dt) {
      try {
        const optsDate = { month: 'short', day: 'numeric' };
        const optsTime = { hour: 'numeric', minute: '2-digit' };
        return dt.toLocaleDateString(undefined, optsDate) + " • " + dt.toLocaleTimeString(undefined, optsTime);
      } catch { return ""; }
    }

    // Convert ISO times to friendly ones on load
    document.querySelectorAll('.time[data-iso]').forEach(el => {
      const iso = el.getAttribute('data-iso');
      if (!iso) return;
      const dt = new Date(iso);
      if (!isNaN(dt)) el.textContent = fmt(dt);
    });

    // Header updated text may be ISO from server; leave as-is if already friendly
    // (No-op here; server already formats it.)

    // Manual refresh button: tells you if new items exist
    document.getElementById('refreshBtn')?.addEventListener('click', async () => {
      try {
        const r = await fetch('/items.json', {cache:'no-store'});
        if (!r.ok) return alert('Could not check.');
        const j = await r.json();
        const count = (j.items||[]).length;
        alert(count ? `Feed has ${count} items.` : 'Still empty.');
      } catch { /* ignore */ }
    });

    // Collect-now: calls the open collector endpoint (if enabled)
    document.getElementById('collectNow')?.addEventListener('click', async () => {
      try {
        const r = await fetch('/collect-open', {method:'POST'});
        const j = await r.json();
        alert(j.ok ? `Collected ${j.wrote} items` : `Error: ${j.error||'collect failed'}`);
        location.reload();
      } catch { alert('Collect failed'); }
    });

    // Light auto-refresh every 3 minutes: if items exist, reload to show newest
    setInterval(async () => {
      try {
        const r = await fetch('/items.json', {cache:'no-store'});
        if (!r.ok) return;
        const j = await r.json();
        if ((j.items||[]).length > 0) location.reload();
      } catch {}
    }, 180000);
  </script>
</body>
</html>
