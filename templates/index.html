<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Purdue Men's Basketball — Feed</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <meta name="color-scheme" content="light dark">
</head>
<body>
  <!-- Header with Purdue logo + wordmark -->
  <header class="site-header">
    <div class="brand">
      <img
        class="logo"
        src="/static/purdue-logo.png"
        alt="Purdue logo"
        width="44"
        height="44"
        onerror="this.onerror=null;this.src='/static/logo.png'"/>
      <div class="titles">
        <h1>Purdue Men's Basketball</h1>
        <!-- Updated time: now formatted to US-friendly text via JS -->
        <div class="updated">Updated:
          <span id="updatedText" data-iso="{{ updated or '' }}">—</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Utility bar: Fight Song (bigger button) -->
  <section class="utility-bar">
    <div class="left">
      <button id="fightSongBtn" class="btn btn-gold btn-large">Fight Song</button>
      <audio id="fightSong" preload="none" src="/static/fight-song.mp3"></audio>
    </div>
    <div class="right"></div>
  </section>

  <!-- Quick links -->
  <nav class="pills">
    {% for link in static_links %}
      <a class="pill" href="{{link.url}}" target="_blank" rel="noopener">{{link.label}}</a>
    {% endfor %}
  </nav>

  <!-- Sources + Search combined -->
  <section class="sources-search">
    <details class="sources-details">
      <summary>Sources</summary>
      <ul class="sources">
        {% for s in sources %}
          <li><a href="{{s.url}}" target="_blank" rel="noopener">{{s.name}}</a></li>
        {% endfor %}
      </ul>
    </details>

    <div class="search-wrap">
      <input id="searchInput" type="search" placeholder="Search articles…" aria-label="Search articles"/>
    </div>
  </section>

  <!-- Feed -->
  <main id="feed">
    {% if items and items|length > 0 %}
      {% for it in items %}
        <article class="card" data-title="{{ it.title|e }}" data-src="{{ it.source|e }}">
          <div class="card-top">
            <span class="src">{{ it.source }}</span>
            <time class="time" data-iso="{{ it.published or '' }}">
              {{ it.published[:16].replace('T',' ') if it.published }}
            </time>
          </div>

          <h3 class="title">
            <a class="title-link" href="{{ it.link }}" target="_blank" rel="noopener">
              {{ it.title }}
            </a>
          </h3>

          {% if it.summary %}
            <p class="summary">{{ it.summary|striptags }}</p>
          {% endif %}

          <div class="card-bottom">
            <a class="read-link" href="{{ it.link }}" target="_blank" rel="noopener">Read →</a>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty">No items yet. Checking for updates…</p>
    {% endif %}
  </main>

  <footer class="site-footer">
    <span>Auto-checks for updates every minute</span>
  </footer>

  <script>
    // --- Format the "Updated" timestamp into US-friendly style ---
    (function(){
      const el = document.getElementById('updatedText');
      if (!el) return;
      const iso = el.getAttribute('data-iso');
      if (!iso) return;
      const dt = new Date(iso);
      if (!isNaN(dt)) {
        const formatted = dt.toLocaleString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        });
        el.textContent = formatted;
      }
    })();

    // Fight Song (no status text or pop-ups)
    const audio = document.getElementById('fightSong');
    const songBtn = document.getElementById('fightSongBtn');
    songBtn?.addEventListener('click', async () => {
      if (!audio) return;
      try {
        if (audio.paused) { audio.currentTime = 0; await audio.play(); }
        else { audio.pause(); audio.currentTime = 0; }
      } catch {}
    });

    // Friendly time labels for each article card
    function fmt(dt){
      try{
        const d = dt.toLocaleDateString('en-US', {month:'short', day:'numeric'});
        const t = dt.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});
        return d + " • " + t;
      }catch{return "";}
    }
    document.querySelectorAll('.time[data-iso]').forEach(el=>{
      const iso = el.getAttribute('data-iso');
      if(!iso) return;
      const dt = new Date(iso);
      if(!isNaN(dt)) el.textContent = fmt(dt);
    });

    // SILENT auto-refresh (no banner/toast/alert)
    const baseline = {
      count: document.querySelectorAll('#feed .card').length || 0,
      updated: document.getElementById('updatedText')?.getAttribute('data-iso') || ""
    };
    async function silentRefresh(){
      try{
        const r = await fetch('/items.json', {cache:'no-store'});
        if(!r.ok) return;
        const j = await r.json();
        const latestCount = (j.items||[]).length;
        const latestUpdated = j.updated || "";
        if ((latestCount > baseline.count) || (baseline.updated && latestUpdated && baseline.updated !== latestUpdated)) {
          location.reload();
        }
      }catch{}
    }
    setInterval(silentRefresh, 60000);

    // Client-side search (title + source + summary)
    const q = document.getElementById('searchInput');
    const cards = Array.from(document.querySelectorAll('#feed .card'));
    function filterCards(){
      const term = (q?.value || '').trim().toLowerCase();
      cards.forEach(c=>{
        if(!term){ c.style.display=''; return; }
        const hay = [
          c.dataset.title || '',
          c.dataset.src || '',
          (c.querySelector('.summary')?.textContent || '')
        ].join(' ').toLowerCase();
        c.style.display = hay.includes(term) ? '' : 'none';
      });
    }
    q?.addEventListener('input', () => { window.requestAnimationFrame(filterCards); });

    // First-visit assist: if items appear after initial empty render, reload once
    (async ()=>{
      if ((document.querySelectorAll('#feed .card').length||0) === 0) {
        try{
          const r = await fetch('/items.json', {cache:'no-store'});
          if (r.ok){
            const j = await r.json();
            if ((j.items||[]).length > 0) location.reload();
          }
        }catch{}
      }
    })();
  </script>
</body>
</html>
