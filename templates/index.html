<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Purdue Men's Basketball — Feed</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
<header class="site-header">
  <h1>Purdue Men's Basketball</h1>
  <div class="updated">Updated: {{ updated or "—" }}</div>
</header>

<nav class="pills">
  {% for link in static_links %}
    <a class="pill" href="{{link.url}}" target="_blank" rel="noopener">{{link.label}}</a>
  {% endfor %}
</nav>

<section class="controls">
  <details>
    <summary>Sources</summary>
    <ul class="sources">
      {% for s in sources %}
      <li><a href="{{s.url}}" target="_blank" rel="noopener">{{s.name}}</a></li>
      {% endfor %}
    </ul>
  </details>
  <button id="refreshBtn">Check for updates</button>
</section>

<main id="feed">
  {% if items and items|length > 0 %}
    {% for it in items %}
    <article class="card">
      <div class="meta">
        <span class="src">{{ it.source }}</span>
        <span class="time">{{ it.published[:16].replace('T',' ') if it.published }}</span>
      </div>
      <h3 class="title"><a href="{{ it.link }}" target="_blank" rel="noopener">{{ it.title }}</a></h3>
      {% if it.summary %}
      <p class="summary">{{ it.summary|safe }}</p>
      {% endif %}
    </article>
    {% endfor %}
  {% else %}
    <p class="empty">No items yet. Try <button id="collectNow" class="inline">collecting now</button>.</p>
  {% endif %}
</main>

<script>
const btn = document.getElementById('refreshBtn');
btn?.addEventListener('click', async () => {
  const r = await fetch('/items.json', {cache:'no-store'});
  if (!r.ok) return;
  const j = await r.json();
  const count = (j.items||[]).length;
  alert(count > 0 ? `Feed has ${count} items.` : 'Still empty.');
});

const collectNow = document.getElementById('collectNow');
collectNow?.addEventListener('click', async () => {
  const r = await fetch('/collect-open', {method:'POST'});
  if (!r.ok) { alert('Collect failed'); return; }
  const j = await r.json();
  alert(j.ok ? `Collected ${j.wrote} items` : `Error: ${j.error}`);
  location.reload();
});

// Light auto-refresh (every 3 minutes)
setInterval(async () => {
  try {
    const r = await fetch('/items.json', {cache:'no-store'});
    if (!r.ok) return;
    const j = await r.json();
    // If there are items, refresh to show new ones
    if ((j.items||[]).length > 0) {
      location.reload();
    }
  } catch(e) {}
}, 180000);
</script>
</body>
</html>
