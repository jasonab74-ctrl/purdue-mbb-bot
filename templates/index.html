<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Purdue Men’s Basketball — Live Feed</title>
  <link rel="manifest" href="/static/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="icon" href="/static/logo.png" type="image/png">
  <link rel="stylesheet" href="/static/style.css">
  <meta name="theme-color" content="#000000">
</head>
<body>

  <!-- Top header -->
  <header class="site-header container">
    <div class="brand">
      <img src="/static/logo.png" class="logo" alt="Purdue">
      <div>
        <h1>Purdue Men’s Basketball — Live Feed</h1>
        <div class="subtle">
          (<span id="itemCount">0</span> dynamic items)
          • Updated: <span id="updatedAgo">—</span>
        </div>
      </div>
    </div>
    <button class="fight-btn" id="fightBtn" aria-pressed="false">▶︎ Fight Song</button>
    <audio id="fightAudio" preload="none" src="/fight_song.mp3" playsinline></audio>
  </header>

  <!-- Hero section (now active) -->
  <div class="container">
    <div class="hero">
      <div class="hero-inner">
        <div class="left">
          <img src="/static/logo.png" alt="Purdue" class="logo">
          <div>
            <div class="badge">Purdue MBB — Live Feed</div>
            <div class="subtle">Updated: <span id="heroUpdated">—</span></div>
          </div>
        </div>
        <button class="fight-btn" id="fightBtnHero">▶︎ Fight Song</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Quick links -->
    <nav class="quick-links" id="quickLinks"></nav>

    <!-- Controls -->
    <div class="controls">
      <div class="grow">
        <input type="search" id="search" placeholder="Filter (e.g., Braden Smith, Matt Painter)" autocomplete="off">
      </div>
      <div>
        <select id="sourceSelect" class="select">
          <option value="__all__">All sources</option>
        </select>
      </div>
      <div class="count-note"><span id="shownCount">0</span> shown</div>
    </div>

    <div class="notice" id="notice" role="status" aria-live="polite">
      New items available — refresh
    </div>

    <!-- Feed list -->
    <main class="feed" id="feed" aria-live="polite"></main>

    <footer>Not affiliated with Purdue University.</footer>
  </div>

  <script>
  // --------- Config ----------
  const STATIC_LINKS = [
    { label: "Purdue – Official MBB Page", url: "https://purduesports.com/sports/mens-basketball" },
    { label: "Purdue – Schedule",          url: "https://purduesports.com/sports/mens-basketball/schedule" },
    { label: "Purdue – Roster",            url: "https://purduesports.com/sports/mens-basketball/roster" },
    { label: "ESPN – Purdue MBB",          url: "https://www.espn.com/mens-college-basketball/team/_/id/2509/purdue-boilermakers" },
    { label: "CBS Sports – Purdue",        url: "https://www.cbssports.com/college-basketball/teams/PUR/purdue-boilermakers/" },
    { label: "Yahoo Sports – Purdue",      url: "https://sports.yahoo.com/ncaab/teams/purdue/" },
    { label: "Hammer & Rails (SB Nation)", url: "https://www.hammerandrails.com/" },
    { label: "GoldandBlack (Rivals)",      url: "https://purdue.rivals.com/" },
    { label: "Barstool – Purdue",          url: "https://www.barstoolsports.com/topics/purdue-boilermakers" },
    { label: "Reddit – r/Boilermakers",    url: "https://www.reddit.com/r/Boilermakers/" },
    { label: "YouTube – Field of 68",      url: "https://www.youtube.com/@thefieldof68" },
    { label: "YouTube – Sleepers Media",   url: "https://www.youtube.com/@SleepersMedia" }
  ];

  const FEED_URL = "/items.json";
  let cacheSignature = "";
  let ALL_ITEMS = [];

  const $ = sel => document.querySelector(sel);
  const feedEl = $("#feed");
  const searchEl = $("#search");
  const sourceEl = $("#sourceSelect");
  const shownCountEl = $("#shownCount");
  const itemCountEl = $("#itemCount");
  const updatedAgoEl = $("#updatedAgo");
  const noticeEl = $("#notice");
  const fightBtn = $("#fightBtn");
  const fightBtnHero = $("#fightBtnHero");
  const fightAudio = $("#fightAudio");

  function fmtDate(d){ try{ return new Date(d).toISOString().slice(0,10); }catch(e){ return ""; } }
  function timeAgo(d){ try{ const diff = Date.now()-new Date(d).getTime(); const m=Math.floor(diff/60000); if(m<1)return"just now"; if(m<60)return m+" min ago"; const h=Math.floor(m/60); if(h<24)return h+" hr ago"; return Math.floor(h/24)+" d ago"; }catch(e){return"—";} }
  function signature(items){ if(!items.length)return"0-0"; return (items[0].date||"")+"-"+items.length; }

  function buildQuickLinks(){ $("#quickLinks").innerHTML = STATIC_LINKS.map(l=>`<a href="${l.url}" target="_blank">${l.label}</a>`).join(""); }
  function uniqueSources(items){ return Array.from(new Set(items.map(it=>it.source||""))).filter(Boolean).sort(); }
  function renderSourceOptions(items){ sourceEl.innerHTML=`<option value="__all__">All sources</option>`+uniqueSources(items).map(s=>`<option value="${s}">${s}</option>`).join(""); }

  function itemMatches(it,q,src){ if(src!=="__all__" && it.source!==src) return false; if(!q)return true; return (it.title+it.summary).toLowerCase().includes(q.toLowerCase()); }

  function renderItems(items){
    let q=searchEl.value.trim(),src=sourceEl.value,filtered=items.filter(it=>itemMatches(it,q,src));
    shownCountEl.textContent=filtered.length; itemCountEl.textContent=items.length;
    const newest=items[0]?.date; if(newest){ updatedAgoEl.textContent=timeAgo(newest); const heroUpd=$("#heroUpdated"); if(heroUpd)heroUpd.textContent=timeAgo(newest); }
    feedEl.innerHTML=filtered.map(it=>`
      <article class="card">
        <h3><a href="${it.link}" target="_blank">${it.title}</a></h3>
        <div class="meta"><span class="source">${it.source||""}</span><span class="date">${fmtDate(it.date)}</span></div>
        ${it.summary?`<div class="snippet">${it.summary.slice(0,220)}</div>`:""}
      </article>`).join("");
  }

  async function loadItems(initial=false){
    const data=await fetch(FEED_URL).then(r=>r.json()).catch(()=>({items:[]}));
    const items=data.items||[]; items.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const sig=signature(items);
    if(initial){ ALL_ITEMS=items; buildQuickLinks(); renderSourceOptions(items); renderItems(items); cacheSignature=sig; return; }
    if(sig!==cacheSignature){ noticeEl.style.display="block"; ALL_ITEMS=items; renderSourceOptions(items); renderItems(items); cacheSignature=sig; setTimeout(()=>noticeEl.style.display="none",5000); }
  }

  function startPolling(){ setInterval(()=>loadItems(false),5*60*1000); }
  function wireFightSong(btn){ btn.addEventListener("click",async()=>{ if(fightAudio.paused){ await fightAudio.play(); btn.textContent="⏸︎ Pause"; }else{ fightAudio.pause(); btn.textContent="▶︎ Fight Song"; } }); fightAudio.addEventListener("ended",()=>{ fightBtn.textContent="▶︎ Fight Song"; if(fightBtnHero) fightBtnHero.textContent="▶︎ Fight Song"; }); }

  (async function(){ await loadItems(true); startPolling(); searchEl.addEventListener("input",()=>renderItems(ALL_ITEMS)); sourceEl.addEventListener("change",()=>renderItems(ALL_ITEMS)); wireFightSong(fightBtn); if(fightBtnHero) wireFightSong(fightBtnHero); })();
  </script>
</body>
</html>
