<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Purdue Boilermakers — Men’s Basketball</title>

  <meta name="theme-color" content="#000000" />
  <link rel="stylesheet" href="static/style.css?v=2025-09-08-purdue" />
</head>
<body>
  <header class="hero">
    <div class="logo-box">
      <img src="static/purdue.png" alt="Purdue logo"
           onerror="this.onerror=null;this.src='static/logo.png';" />
    </div>
    <div class="hero-titles">
      <h1>Purdue Boilermakers — Men’s Basketball</h1>
      <div class="sub">Live team feed · auto-updates</div>
    </div>
    <button id="songBtn" class="song-btn" type="button">▶ Hail Purdue</button>
    <audio id="song" src="static/fight-song.mp3" preload="auto"></audio>
  </header>

  <!-- Quick links / buttons -->
  <nav id="links" class="pill-row"></nav>

  <section class="controls">
    <div class="control">
      <label>Source:</label>
      <select id="sourceSelect"></select>
    </div>
    <div class="control right">
      <label>Updated:</label>
      <span id="updated">—</span>
    </div>
  </section>

  <main id="feed" aria-live="polite"></main>

  <template id="emptyTpl">
    <div class="empty">
      <div class="empty-title">No articles yet</div>
      <div class="empty-sub">
        If you just deployed, GitHub Actions will write <code>items.json</code>
        within ~30 minutes. You can also seed <code>items.json</code> manually.
      </div>
      <a class="pill" href="items.json" target="_blank" rel="noopener">View items.json</a>
    </div>
  </template>

  <script>
    const feedEl = document.getElementById('feed');
    const updatedEl = document.getElementById('updated');
    const sourceSelect = document.getElementById('sourceSelect');
    const linksEl = document.getElementById('links');

    // Fight song inline (never open new tab)
    const song = document.getElementById('song');
    const songBtn = document.getElementById('songBtn');
    songBtn?.addEventListener('click', async () => {
      try{
        if (song.paused) { await song.play(); songBtn.textContent = '⏸ Hail Purdue'; }
        else { song.pause(); song.currentTime=0; songBtn.textContent = '▶ Hail Purdue'; }
      }catch{}
    });

    const fmtUS = iso => {
      try{
        const d = new Date(iso);
        return d.toLocaleString('en-US', {
          year:'numeric', month:'short', day:'numeric',
          hour:'numeric', minute:'2-digit'
        });
      }catch{ return iso||''; }
    };

    function renderLinks(links){
      // Extra buttons we always want (in case feeds.json didn’t include them)
      const defaults = [
        {label:"Schedule", url:"https://purduesports.com/sports/mens-basketball/schedule"},
        {label:"Roster", url:"https://purduesports.com/sports/mens-basketball/roster"},
        {label:"Tickets", url:"https://purduesports.com/sports/2024/9/1/tickets.aspx"},
        {label:"Reddit — r/Boilermakers", url:"https://www.reddit.com/r/Boilermakers/"},
        {label:"ESPN Team", url:"https://www.espn.com/mens-college-basketball/team/_/id/2509/purdue-boilermakers"},
        {label:"KenPom", url:"https://kenpom.com/"},
        {label:"Sports-Reference", url:"https://www.sports-reference.com/cbb/schools/purdue/"},
        {label:"Big Ten Standings", url:"https://www.espn.com/mens-college-basketball/standings/_/group/7"},
        {label:"AP Top 25", url:"https://apnews.com/hub/ap-top-25-mens-college-basketball-poll"},
        {label:"Bracketology", url:"https://www.espn.com/mens-college-basketball/bracketology"},
        {label:"Highlights", url:"https://www.youtube.com/results?search_query=Purdue+men%27s+basketball+highlights"},
        {label:"247Sports", url:"https://247sports.com/college/purdue/"},
        {label:"Rivals", url:"https://purdue.rivals.com/"},
        {label:"CBS Purdue", url:"https://www.cbssports.com/college-basketball/teams/PUR/purdue-boilermakers/"}
      ];

      const seen = new Set();
      const list = [...(links||[]), ...defaults].filter(x=>{
        const k=(x.label||'').toLowerCase().trim();
        if(!k||seen.has(k)) return false; seen.add(k); return true;
      });

      linksEl.innerHTML = '';
      list.forEach(l=>{
        const a = document.createElement('a');
        a.className = 'pill';
        a.href = l.url; a.target='_blank'; a.rel='noopener';
        a.textContent = l.label;
        linksEl.appendChild(a);
      });
    }

    const normSource = s => {
      if (typeof s === 'string') return s;
      if (s && typeof s === 'object') return s.label || s.name || s.id || String(s);
      return String(s||'');
    };

    function buildSourceDropdown(items, curated){
      sourceSelect.innerHTML='';
      const optAll = document.createElement('option');
      optAll.value=''; optAll.textContent='All sources';
      sourceSelect.appendChild(optAll);

      const curatedList = (curated||[]).map(normSource).filter(Boolean);
      const derived = Array.from(new Set((items||[]).map(i => normSource(i.source || i.feed)).filter(Boolean))).sort();
      const list = curatedList.length ? curatedList : derived;

      list.forEach(label=>{
        const o=document.createElement('option'); o.value=label; o.textContent=label;
        sourceSelect.appendChild(o);
      });
    }

    function renderItems(items){
      feedEl.innerHTML='';
      if(!items || !items.length){
        const tpl=document.getElementById('emptyTpl');
        feedEl.appendChild(tpl.content.cloneNode(true));
        return;
      }
      items.forEach(it=>{
        const card=document.createElement('article'); card.className='card';
        const a=document.createElement('a'); a.className='title'; a.href=it.link; a.target='_blank'; a.rel='noopener';
        a.textContent = it.title || '(untitled)';
        const meta=document.createElement('div'); meta.className='meta';
        const src = normSource(it.source||it.feed);
        meta.textContent = `${src} • ${fmtUS(it.published || it.updated)}`;
        card.appendChild(a); card.appendChild(meta); feedEl.appendChild(card);
      });
    }

    function applyFilter(all){
      const src = sourceSelect.value;
      const list = src ? all.filter(i => normSource(i.source||i.feed) === src) : all;
      renderItems(list);
    }

    async function loadAndRender(initial=false){
      try{
        const r = await fetch('items.json?ts='+Date.now(), {cache:'no-store'});
        const data = await r.json();
        renderLinks(data.links || []);
        buildSourceDropdown(data.items || [], data.sources || []);
        updatedEl.textContent = data.updated ? fmtUS(data.updated) : '—';
        renderItems(data.items || []);
        if(initial) sourceSelect.addEventListener('change', ()=>applyFilter(data.items||[]));
      }catch{
        updatedEl.textContent = 'load failed';
      }
    }

    loadAndRender(true);
    // Check for updates every 10 minutes
    setInterval(()=>loadAndRender(false), 10*60*1000);
  </script>
</body>
</html>
