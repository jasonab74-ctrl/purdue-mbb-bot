<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Purdue Boilermakers — Men’s Basketball</title>
  <meta name="description" content="Live Purdue men's basketball feed with auto-updates." />

  <!-- Icons: use relative paths so GitHub Pages subpaths work -->
  <link rel="icon" href="static/logo.png" />
  <link rel="apple-touch-icon" href="static/logo.png" />
  <meta name="apple-mobile-web-app-title" content="Purdue Hoops" />
  <meta name="theme-color" content="#000000" />

  <link rel="stylesheet" href="static/style.css" />
</head>
<body>
  <header class="hero">
    <div class="brand">
      <img src="static/logo.png" alt="Purdue logo" class="brand-logo" />
      <div class="brand-text">
        <h1>Purdue Boilermakers — <span>Men’s Basketball</span></h1>
        <div class="sub">Live team feed · auto-updates</div>
      </div>
    </div>

    <!-- Fight song button (fixed width to prevent label “bounce”) -->
    <button id="songBtn" class="pill cta" aria-label="Play Hail Purdue">
      <span class="cta-dot" aria-hidden="true">▶</span>
      Hail Purdue
    </button>

    <!-- Song is standardized: static/fight-song.mp3 -->
    <audio id="song" preload="auto">
      <source src="static/fight-song.mp3" type="audio/mpeg" />
    </audio>
  </header>

  <main class="wrap" id="app">
    <section id="links" class="links-row"></section>

    <div class="meta-row">
      <label class="meta">Source:</label>
      <select id="sourceSelect" class="select"></select>

      <div class="updated">
        <span>Updated:</span>
        <time id="updatedTs">—</time>
      </div>
    </div>

    <section id="feed" class="feed"></section>
  </main>

  <script>
    // ——— Fight song control (no new window) ———
    (function () {
      const btn = document.getElementById('songBtn');
      const audio = document.getElementById('song');
      let playing = false;

      function setBtnState(isPlaying) {
        playing = isPlaying;
        btn.classList.toggle('playing', playing);
        btn.innerHTML = (playing ? '⏸' : '<span class="cta-dot">▶</span>') + ' Hail Purdue';
      }

      btn.addEventListener('click', async () => {
        try {
          if (!playing) {
            audio.currentTime = 0;
            await audio.play();
            setBtnState(true);
          } else {
            audio.pause();
            setBtnState(false);
          }
        } catch (err) {
          // If autoplay is blocked until user gesture, clicking again will work.
          console.error('Audio play failed:', err);
          setBtnState(false);
        }
      });

      audio.addEventListener('ended', () => setBtnState(false));
      audio.addEventListener('pause', () => setBtnState(false));
      audio.addEventListener('play',  () => setBtnState(true));
    })();

    // ——— Feed loader (hardened: UI reads items.json only) ———
    async function loadFeed() {
      try {
        const res = await fetch('items.json', { cache: 'no-store' });
        const data = await res.json();

        // Updated stamp (US style)
        const ts = data.updated ? new Date(data.updated) : new Date();
        document.getElementById('updatedTs').textContent =
          ts.toLocaleString('en-US', { year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit' });

        // Quick-link pills
        const links = document.getElementById('links');
        links.innerHTML = (data.links || []).map(l => `
          <a class="pill" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>
        `).join('');

        // Source dropdown
        const sel = document.getElementById('sourceSelect');
        const sources = ['All sources'].concat(data.sources || []);
        sel.innerHTML = sources.map((s,i)=>`<option value="${i===0?'':s}">${s}</option>`).join('');

        // Render list
        const feed = document.getElementById('feed');
        const render = (items) => {
          feed.innerHTML = (items || []).map(it => `
            <article class="card">
              <a class="card-link" href="${it.link}" target="_blank" rel="noopener">
                <h3 class="card-title">${it.title}</h3>
                <div class="card-meta">
                  <span class="src">${it.source || ''}</span>
                  <span class="dot">•</span>
                  <time class="ts">${new Date(it.published).toLocaleString('en-US')}</time>
                </div>
                ${it.summary ? `<p class="card-sum">${it.summary}</p>` : ``}
              </a>
            </article>
          `).join('');
        };

        render(data.items || []);

        sel.addEventListener('change', () => {
          const v = sel.value;
          if (!v) return render(data.items || []);
          render((data.items || []).filter(it => (it.source || '').toLowerCase() === v.toLowerCase()));
        });
      } catch (e) {
        console.error('loadFeed error', e);
      }
    }
    loadFeed();
  </script>
</body>
</html>
