<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Purdue Boilermakers — Men’s Basketball</title>
  <link rel="preload" href="static/hail-purdue.mp3" as="audio">
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <header class="hero">
    <img class="logo" src="static/logo.png" alt="Purdue P logo" width="64" height="64" decoding="async">
    <div class="title-wrap">
      <h1 class="title">Purdue Boilermakers — <span class="nowrap">Men’s Basketball</span></h1>
      <p class="subtitle">Live team feed · auto-updates</p>
    </div>

    <button id="songBtn" class="pill primary" type="button" aria-label="Play Hail Purdue">
      <span class="play-dot" aria-hidden="true">▶︎</span> Hail Purdue
    </button>

    <audio id="song" preload="auto">
      <source src="static/hail-purdue.mp3" type="audio/mpeg">
    </audio>
  </header>

  <nav class="chips">
    <a class="chip" href="https://purduesports.com/sports/mens-basketball/schedule" target="_blank" rel="noopener">Schedule</a>
    <a class="chip" href="https://purduesports.com/sports/mens-basketball/roster" target="_blank" rel="noopener">Roster</a>
    <a class="chip" href="https://purduesports.com/sports/mens-basketball/tickets" target="_blank" rel="noopener">Tickets</a>
    <a class="chip" href="https://www.reddit.com/r/Boilermakers/" target="_blank" rel="noopener">Reddit — r/Boilermakers</a>
    <a class="chip" href="https://www.espn.com/mens-college-basketball/team/_/id/2509/purdue-boilermakers" target="_blank" rel="noopener">ESPN Team</a>
    <a class="chip" href="https://kenpom.com/" target="_blank" rel="noopener">KenPom</a>
    <a class="chip" href="https://www.sports-reference.com/cbb/schools/purdue/" target="_blank" rel="noopener">Sports-Reference</a>
    <a class="chip" href="https://bigten.org/standings.aspx?path=mbball" target="_blank" rel="noopener">Big Ten Standings</a>
    <a class="chip" href="https://apnews.com/hub/ap-top-25-college-basketball-poll" target="_blank" rel="noopener">AP Top 25</a>
    <a class="chip" href="https://www.youtube.com/results?search_query=Purdue+Men%27s+Basketball+highlights" target="_blank" rel="noopener">Highlights</a>
    <a class="chip" href="https://247sports.com/college/purdue/" target="_blank" rel="noopener">247Sports</a>
    <a class="chip" href="https://purdue.rivals.com/" target="_blank" rel="noopener">Rivals</a>
  </nav>

  <section class="toolbar">
    <div class="field">
      <label for="sourceSel">Source:</label>
      <select id="sourceSel">
        <!-- options injected from FIXED_SOURCES below -->
      </select>
    </div>
    <div class="updated" id="updated">Updated: —</div>
  </section>

  <main id="feed" class="feed" aria-live="polite"></main>

  <template id="cardTpl">
    <article class="card">
      <a class="card-link" target="_blank" rel="noopener">
        <h3 class="card-title"></h3>
        <div class="meta">
          <span class="source"></span>
          <span class="dot">•</span>
          <time class="when"></time>
        </div>
      </a>
    </article>
  </template>

  <script>
    // ------------- HARDENED: fixed dropdown list (doesn't get overwritten) -------------
    const FIXED_SOURCES = [
      "All sources",
      "PurdueSports.com",
      "Journal & Courier",
      "GoldandBlack.com",
      "Hammer and Rails",
      "The Athletic",
      "ESPN",
      "Yahoo Sports",
      "Sports Illustrated",
      "CBS Sports",
      "Big Ten Network"
    ];

    // Basic football noise filter (titles or source lines that scream football)
    const BAD_WORDS = [
      "football", "Ross-Ade", "QB", "quarterback", "wide receiver", "running back",
      "Colts", "NFL", "Pro Football", "Notre Dame Football"
    ];

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // populate the source dropdown (no more reverting)
    const sel = $('#sourceSel');
    FIXED_SOURCES.forEach((name, i) => {
      const opt = document.createElement('option');
      opt.textContent = name;
      opt.value = name;
      if (i === 0) opt.selected = true;
      sel.appendChild(opt);
    });

    // play/pause song (no navigation, iOS-safe because it’s a direct tap)
    const song = $('#song');
    const songBtn = $('#songBtn');
    let playing = false;
    songBtn.addEventListener('click', () => {
      if (!playing) { song.currentTime = 0; song.play(); playing = true; songBtn.classList.add('playing'); }
      else { song.pause(); playing = false; songBtn.classList.remove('playing'); }
    });
    song.addEventListener('ended', () => { playing = false; songBtn.classList.remove('playing'); });

    // robust parse of items (supports multiple shapes)
    function normalizeItem(it) {
      const link = it.url || it.link || it.permalink || '#';
      const title = it.title || it.headline || 'Untitled';
      const src = it.source_name || it.source || (it.source && it.source.name) || it.site || '';
      const dRaw = it.published_at || it.published || it.date || it.isoDate || it.updated || null;
      const d = dRaw ? new Date(dRaw) : null;
      return { title, link, src, date: d };
    }

    function isBasketball(item) {
      const hay = (item.title + ' ' + item.src).toLowerCase();
      return !BAD_WORDS.some(w => hay.includes(w.toLowerCase()));
    }

    function formatUS(d) {
      try {
        return new Intl.DateTimeFormat('en-US',{
          year:'numeric', month:'short', day:'numeric',
          hour:'numeric', minute:'2-digit'
        }).format(d);
      } catch { return ''; }
    }

    async function load() {
      // fetch items.json (root). If your action writes somewhere else, update this path.
      const res = await fetch('items.json', { cache: 'no-cache' });
      const data = await res.json();
      const arr = Array.isArray(data) ? data : (data.items || []);
      const items = arr.map(normalizeItem).filter(it => it.title && it.link);

      // Set updated (now) to indicate when the page processed the file
      const now = new Date();
      $('#updated').textContent = 'Updated: ' + formatUS(now);

      // Render once and keep stable; selection filters in-place
      render(items);

      sel.addEventListener('change', () => render(items));
    }

    function render(allItems) {
      const feed = $('#feed');
      feed.innerHTML = '';

      const chosen = sel.value;
      let items = allItems;

      if (chosen && chosen !== 'All sources') {
        items = items.filter(it =>
          (it.src || '').toLowerCase().includes(chosen.toLowerCase())
        );
      }

      // basketball-first
      items = items.filter(isBasketball);

      // newest first; tolerate missing dates
      items.sort((a,b) => (b.date||0) - (a.date||0));

      const tpl = $('#cardTpl').content;

      items.forEach(it => {
        const node = tpl.cloneNode(true);
        const a = node.querySelector('.card-link');
        a.href = it.link;
        node.querySelector('.card-title').textContent = it.title.trim();
        node.querySelector('.source').textContent = it.src || '—';
        node.querySelector('.when').textContent = it.date ? formatUS(it.date) : '';
        feed.appendChild(node);
      });

      if (items.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'No articles yet for this selection.';
        feed.appendChild(empty);
      }
    }

    load().catch(err => {
      console.error(err);
      $('#feed').innerHTML = '<p class="empty">Could not load items.json.</p>';
    });
  </script>
</body>
</html>