<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Purdue Boilermakers — Men's Basketball</title>
  <link rel="icon" href="static/logo.png" />
  <link rel="stylesheet" href="static/style.css" />
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <img class="brand-logo" src="static/logo.png" alt="Purdue P" />
      <div class="brand-text">
        <h1>Purdue Boilermakers — Men’s Basketball</h1>
        <div class="sub">Live team feed · auto-updates</div>
      </div>
    </div>

    <button id="fightBtn" class="fight-btn" aria-label="Play Hail Purdue">
      <span class="fight-icon">▶</span>
      <span>Hail Purdue</span>
    </button>

    <!-- Preload but don't autoplay (iOS requires user gesture) -->
    <audio id="fightAudio" preload="none">
      <source src="static/fight-song.mp3" type="audio/mpeg" />
    </audio>
  </header>

  <nav class="quick-links">
    <a class="pill" href="https://purduesports.com/sports/mens-basketball/schedule" target="_blank" rel="noopener">Schedule</a>
    <a class="pill" href="https://purduesports.com/sports/mens-basketball/roster" target="_blank" rel="noopener">Roster</a>
    <a class="pill" href="https://purduesports.com/sports/mens-basketball" target="_blank" rel="noopener">Tickets</a>
    <a class="pill" href="https://www.reddit.com/r/Boilermakers/" target="_blank" rel="noopener">Reddit — r/Boilermakers</a>
    <a class="pill" href="https://www.espn.com/mens-college-basketball/team/_/id/2509/purdue-boilermakers" target="_blank" rel="noopener">ESPN Team</a>
    <a class="pill" href="https://kenpom.com/" target="_blank" rel="noopener">KenPom</a>
    <a class="pill" href="https://www.sports-reference.com/cbb/schools/purdue/" target="_blank" rel="noopener">Sports-Reference</a>
    <a class="pill" href="https://bigten.org/standings.aspx?path=mbball" target="_blank" rel="noopener">Big Ten Standings</a>
    <a class="pill" href="https://apnews.com/hub/ap-top-25-college-basketball-poll" target="_blank" rel="noopener">AP Top 25</a>
    <a class="pill" href="https://www.youtube.com/results?search_query=purdue+basketball+highlights" target="_blank" rel="noopener">Highlights</a>
    <a class="pill" href="https://247sports.com/college/purdue/" target="_blank" rel="noopener">247Sports</a>
    <a class="pill" href="https://www.cbssports.com/college-basketball/teams/PUR/purdue-boilermakers/" target="_blank" rel="noopener">CBS Purdue</a>
    <a class="pill" href="https://purdue.rivals.com/" target="_blank" rel="noopener">Rivals</a>
  </nav>

  <section class="controls">
    <div class="control">
      <label for="sourceSelect">Source:</label>
      <select id="sourceSelect"></select>
    </div>
    <div class="updated">
      <span>Updated:</span>
      <time id="updatedTime">—</time>
    </div>
  </section>

  <main id="feed" class="feed"></main>

  <template id="item-tpl">
    <article class="card">
      <a class="card-link" href="#" target="_blank" rel="noopener">
        <h2 class="card-title"></h2>
        <div class="meta">
          <span class="card-source"></span>
          <span class="dot">•</span>
          <time class="card-time"></time>
        </div>
      </a>
    </article>
  </template>

  <script>
    // --- Fight song (no bouncing, stable width) ---
    (function () {
      const btn = document.getElementById('fightBtn');
      const audio = document.getElementById('fightAudio');
      const icon = btn.querySelector('.fight-icon');

      let playing = false;
      btn.addEventListener('click', async () => {
        try {
          if (!playing) {
            await audio.play();
            playing = true;
            icon.textContent = '⏸';
          } else {
            audio.pause();
            playing = false;
            icon.textContent = '▶';
          }
        } catch (e) {
          console.log('Audio play failed (likely blocked until gesture):', e);
        }
      });
      audio.addEventListener('ended', () => {
        playing = false;
        icon.textContent = '▶';
      });
    })();

    // --- Load items.json and render ---
    const FEED_EL = document.getElementById('feed');
    const SRC_SELECT = document.getElementById('sourceSelect');
    const UPDATED_EL = document.getElementById('updatedTime');
    const ITEM_TPL = document.getElementById('item-tpl');

    const US_FMT = new Intl.DateTimeFormat('en-US', {
      month: 'short', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: '2-digit'
    });

    let allItems = [];
    let sources = new Set();

    async function loadItems() {
      const res = await fetch('items.json', { cache: 'no-store' });
      const data = await res.json();

      // Updated timestamp
      const updated = data.updated || new Date().toISOString();
      UPDATED_EL.textContent = US_FMT.format(new Date(updated));

      allItems = data.items || [];
      sources = new Set(['All sources']);
      allItems.forEach(it => sources.add(it.source));

      // populate dropdown (stable order)
      SRC_SELECT.innerHTML = '';
      Array.from(sources).forEach(src => {
        const opt = document.createElement('option');
        opt.value = src;
        opt.textContent = src;
        SRC_SELECT.appendChild(opt);
      });

      render();
    }

    function render() {
      const sel = SRC_SELECT.value || 'All sources';
      FEED_EL.innerHTML = '';

      const items = allItems.filter(it => sel === 'All sources' ? true : it.source === sel);

      for (const it of items) {
        const node = ITEM_TPL.content.cloneNode(true);
        node.querySelector('.card-link').href = it.link;
        node.querySelector('.card-title').textContent = it.title;
        node.querySelector('.card-source').textContent = it.source;
        node.querySelector('.card-time').textContent = US_FMT.format(new Date(it.published));
        FEED_EL.appendChild(node);
      }
    }

    SRC_SELECT.addEventListener('change', render);

    // Initial + periodic refresh (client-side)
    loadItems();
    // Check every 5 minutes; renders only if items.json changed on server
    setInterval(loadItems, 5 * 60 * 1000);
  </script>
</body>
</html>