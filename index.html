<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1017" />
  <title>Purdue Boilermakers Hub</title>

  <link rel="stylesheet" href="./static/css/app.css?v=13" />
  <link rel="stylesheet" href="./static/css/mobile-tweaks.css?v=13" />
  <link rel="icon" href="./static/img/favicon.png" />
  <meta name="description" content="Purdue Boilermakers Men's Basketball Hub — live Purdue MBB headlines, schedule, roster, rankings, and insider links auto-updated via GitHub Actions.">

  <style>
    .pill.active{ box-shadow: inset 0 0 0 2px rgba(242,201,76,.25); border-color: rgba(242,201,76,.35); background:#172233; }
    .pill[disabled]{ opacity:.45; cursor:not-allowed!important; pointer-events:none; }
    .pill .count{ color:var(--muted); margin-left:.35rem; font-size: var(--fs-0); }
    .empty-note{ padding:12px; border-radius:10px; background:#0e1623; color:var(--muted); }
    .load-more-row{ display:flex; justify-content:center; margin:16px 0 4px; }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.12); background:#101a28; color:#e8eef9; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn:hover{ background:#132033; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .game{ padding:10px 12px; border-radius:12px; background:#0f1622; margin:8px 0; }
    .game-title{ font-weight:700; }
    .game-sub{ color:var(--muted); font-size: var(--fs-0); }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand-badge"><div class="brand-dot"></div></div>
    <div class="brand-title">Boilermakers</div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- NEWS -->
      <section id="news" class="panel" aria-labelledby="news-title">
        <div class="panel-hd"><h2 id="news-title">Top Headlines</h2></div>
        <div class="panel-subnote">Refreshed every 30 min • Auto-updated via GitHub Actions</div>

        <div class="pills" id="newsPills" role="tablist" aria-label="Filter headlines" style="margin-top:10px;">
          <button class="pill active" data-tier="all" role="tab" aria-selected="true" aria-controls="cards">all<span class="count"></span></button>
          <button class="pill" data-tier="official" role="tab" aria-selected="false" aria-controls="cards">official<span class="count"></span></button>
          <button class="pill" data-tier="insiders" role="tab" aria-selected="false" aria-controls="cards">insiders<span class="count"></span></button>
          <button class="pill" data-tier="national" role="tab" aria-selected="false" aria-controls="cards">national<span class="count"></span></button>
        </div>

        <div id="hero" class="hero"></div>
        <div id="cards" class="card-grid" style="margin-top:12px;"></div>
        <div class="load-more-row"><button id="loadMoreBtn" class="btn" hidden>Load more</button></div>
      </section>

      <!-- RIGHT RAIL -->
      <aside class="rail">
        <section id="rankings" class="panel">
          <h3>Rankings</h3>
          <div class="simple-list" id="rankingsList"><div>AP Top 25: —</div><div>KenPom: —</div></div>
          <div id="rankingsStamp" class="footer-note" style="margin-top:6px;"></div>
        </section>

        <section id="schedule" class="panel">
          <h3>Upcoming Schedule</h3>
          <div id="scheduleList" class="simple-list"></div>
          <div id="schedStamp" class="footer-note" style="margin-top:6px;"></div>
        </section>

        <section id="insiders" class="panel">
          <h3>Insider / Beat Links</h3>
          <div id="insiderList" class="simple-list">No insider items (yet).</div>
        </section>
      </aside>
    </div>

    <section id="roster" class="panel" style="margin-top:18px;">
      <h3>Roster</h3>
      <div id="rosterGrid" class="roster"><div class="muted small">No roster data.</div></div>
    </section>

    <section id="videos" class="panel" style="margin-top:18px;">
      <h3>Latest Videos</h3>
      <div id="videoGrid" class="card-grid"><div class="muted small">No videos found.</div></div>
    </section>
  </main>

  <footer class="footer-fixed">© 2025 Boilermakers Hub • Auto-updated every 30 min</footer>

  <script>
  /* ---------- tiny utils ---------- */
  const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=(s="")=>(s+"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  const timeAgo=(ts)=>{ if(!ts)return""; if(ts<1e12)ts*=1000; const d=Date.now()-ts,m=Math.floor(d/6e4); if(m<60)return m+"m ago"; const h=Math.floor(m/60); if(h<24)return h+"h ago"; return Math.floor(h/24)+"d ago"; };
  async function load(url){ try{ const r=await fetch(url+"?v="+Date.now(),{cache:"no-store"}); if(!r.ok) throw 0; return await r.json(); } catch { return null; } }
  async function loadFirstExisting(paths){ for(const p of paths){ const j=await load(p); if(j) return j; } return null; }
  function hostFrom(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{ return ""; } }
  function parseTs(v){
    if(v==null) return null;
    if(typeof v==="number") return v;
    if(typeof v==="string"){
      // numbers in strings
      if(/^\d{10,13}$/.test(v)) return Number(v);
      const d=new Date(v); if(!isNaN(d)) return d.getTime();
    }
    return null;
  }

  /* ---------- Headlines normalization & filtering ---------- */
  const POS_MBB=["men's basketball","mens basketball","mbb","basketball","hoops","matt painter","mackey","paint crew","zach edey","braden smith","fletcher loyer","caleb furst","ncaa","big ten","march madness","exhibition","tournament"];
  const HINT_PATH=/\/(mbb|m-basketball|mens?-basketball|men-basketball|basketball|college-basketball|ncaa-basketball)\//i;
  const NEG_FB=["football","fball","nfl","qb","quarterback","running back","wide receiver","offensive line","defensive line","touchdown","ross-ade","ryan walters","hudson card","coach walters"];
  const PU_TOKENS=["purdue","boilermaker","west lafayette","mackey","purduesports","hammerandrails","goldandblack"];
  const TIERS=["official","insiders","national"];

  function normalizeNewsArray(data){
    // accept various shapes: {items}, {entries}, array at root
    const arr = Array.isArray(data) ? data :
                Array.isArray(data?.items) ? data.items :
                Array.isArray(data?.entries) ? data.entries : [];
    return arr.map(x=>{
      const link = x.link || x.url || x.permalink || x.guid || "";
      const title = x.title || x.headline || x.name || "";
      const summary = x.summary || x.description || x.snippet || "";
      const image = x.image || x.imageUrl || x.enclosure?.url || x.thumbnail || "";
      const tier = (x.tier && TIERS.includes(x.tier)? x.tier : (x.sourceTier||"")) || guessTier(hostFrom(link));
      const source = x.source || x.site || hostFrom(link) || "";
      const ts = parseTs(x.ts) || parseTs(x.published_at) || parseTs(x.pubDate) || parseTs(x.date) || parseTs(x.isoDate) || parseTs(x.updated) || Date.now();
      return {link,title,summary,image,tier,source,ts};
    }).filter(i => i.link && i.title);
  }
  function guessTier(host){
    if(/purduesports\.com/i.test(host)) return "official";
    if(/hammerandrails|goldandblack|247sports|rivals/i.test(host)) return "insiders";
    return "national";
  }
  function uniqBy(arr,key){ const seen=new Set(); const out=[]; for(const a of arr){ const k=key(a); if(seen.has(k)) continue; seen.add(k); out.push(a); } return out; }

  function notFootball(it){
    const blob=(it.title+" "+(it.summary||"")+" "+it.link).toLowerCase();
    if (NEG_FB.some(k=>blob.includes(k))) return false;
    if (it.link.toLowerCase().includes("/football")) return false;
    return true;
  }
  function isBasketballSignal(it){
    const t=(it.title+" "+(it.summary||"")).toLowerCase();
    return HINT_PATH.test(it.link) || POS_MBB.some(k=>t.includes(k)) || /men'?s?\s*basketball/.test(t);
  }
  function isPurdueish(it){
    const t=(it.title+" "+(it.summary||"")+" "+it.source).toLowerCase();
    return PU_TOKENS.some(k=>t.includes(k)) || /purdue/.test(t);
  }

  function widenToTen(items){
    // newest first
    const clean = items.slice().filter(notFootball).sort((a,b)=>b.ts-a.ts);

    // Strong: Purdue-ish + clear hoops signal
    const A = clean.filter(it => isPurdueish(it) && isBasketballSignal(it));
    if (A.length>=10) return A.slice(0,10);

    // Normal: hoops signal (keep Purdue bias via sort order)
    const B = clean.filter(it => isBasketballSignal(it));
    const AB = uniqBy([...A,...B], x=>x.link).slice(0,10);
    if (AB.length>=10) return AB;

    // Soft: Purdue-ish non-football
    const C = clean.filter(it => isPurdueish(it));
    const ABC = uniqBy([...AB,...C], x=>x.link).slice(0,10);
    if (ABC.length>=10) return ABC;

    // Last resort: newest non-football
    return clean.slice(0, Math.min(10, clean.length));
  }

  function byTier(items, t){ return t==="all" ? items : items.filter(i=>i.tier===t); }

  let NEWS_ALL=[], CURRENT_TIER="all", VISIBLE_COUNT=10, STEP=10;

  function drawNews(){
    const hero=$("#hero"), cards=$("#cards"), loadBtn=$("#loadMoreBtn"), insiderList=$("#insiderList");
    const filtered = byTier(NEWS_ALL, CURRENT_TIER);
    if(!filtered.length){
      hero.innerHTML=`<div class="empty-note">No Purdue Men's Basketball headlines right now. New stories will appear here automatically.</div>`;
      cards.innerHTML=""; loadBtn.hidden=true; insiderList.textContent="No insider items (yet)."; return;
    }
    const view = filtered.slice(0, Math.min(VISIBLE_COUNT, filtered.length));
    const h=view[0];
    hero.innerHTML=`
      <a class="hero-img" href="${esc(h.link)}" target="_blank" rel="noopener">
        ${h.image?`<img src="${esc(h.image)}" alt="">`:""}
      </a>
      <div class="hero-meta">
        <span class="small muted">${esc(h.tier)} • ${esc(h.source)}</span><br/>
        <a href="${esc(h.link)}" target="_blank" class="hero-title">${esc(h.title)}</a><br/>
        <span class="small muted">${timeAgo(h.ts)}</span>
      </div>`;
    cards.innerHTML=view.slice(1).map(it=>`
      <div class="card">
        ${it.image?`<div class="card-thumb"><img src="${esc(it.image)}" alt=""></div>`:""}
        <div class="card-body">
          <div class="card-kickers">
            <span class="kicker">${esc(it.tier)}</span>
            <span class="kicker src">${esc(it.source)}</span>
          </div>
          <a href="${esc(it.link)}" target="_blank" class="card-title">${esc(it.title)}</a>
          <div class="card-meta">${timeAgo(it.ts)} • ${esc(it.source)}</div>
        </div>
      </div>`).join("");

    const insiderItems = NEWS_ALL.filter(i=>i.tier==="insiders");
    $("#insiderList").innerHTML = insiderItems.length
      ? insiderItems.slice(0,6).map(i=>`<a class="link-card" href="${esc(i.link)}" target="_blank" rel="noopener">${esc(i.title)}</a>`).join("")
      : "No insider items (yet).";

    loadBtn.hidden = view.length >= filtered.length;
    loadBtn.textContent = loadBtn.hidden ? "No more stories" : "Load more";
  }
  function updatePills(){
    const counts={
      all: NEWS_ALL.length,
      official: NEWS_ALL.filter(i=>i.tier==="official").length,
      insiders: NEWS_ALL.filter(i=>i.tier==="insiders").length,
      national: NEWS_ALL.filter(i=>i.tier==="national").length
    };
    $$("#newsPills .pill").forEach(b=>{
      const t=b.dataset.tier, n=counts[t]??0;
      b.querySelector(".count").textContent=` (${n})`;
      b.disabled=(t!=="all" && n===0);
      b.classList.toggle("active", t===CURRENT_TIER);
      b.setAttribute("aria-selected", t===CURRENT_TIER ? "true" : "false");
    });
  }

  async function initNews(){
    // Try several candidate files; accept any one that exists
    const newsData = await loadFirstExisting([
      "static/data/news.json",
      "static/data/news_all.json",
      "static/data/collect.json"
    ]);
    const normalized = normalizeNewsArray(newsData || []);
    NEWS_ALL = widenToTen(normalized);         // always up to 10, football excluded, newest first
    VISIBLE_COUNT = 10;

    drawNews(); updatePills();

    $("#newsPills").addEventListener("click", e=>{
      const btn=e.target.closest(".pill"); if(!btn||btn.disabled) return;
      const tier=btn.dataset.tier; if(tier===CURRENT_TIER) return;
      CURRENT_TIER=tier; VISIBLE_COUNT=10; drawNews(); updatePills();
      $("#news").scrollIntoView({behavior:"smooth", block:"start"});
    });
    $("#loadMoreBtn").addEventListener("click", ()=>{ VISIBLE_COUNT += STEP; drawNews(); });
  }

  /* ---------- Rankings ---------- */
  function fmtUpdated(ts){ if(!ts) return ""; const d=new Date(ts<1e12?ts*1000:ts); return d.toLocaleString(undefined,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}); }
  async function initRankings(){
    const el=$("#rankingsList"), stamp=$("#rankingsStamp"), data=await loadFirstExisting([
      "static/data/rankings.json",
      "static/teams/purdue-mbb/rankings.json"
    ]);
    const apRank=data?.ap?.rank??data?.ap_rank??"—", apUrl=data?.ap?.url||"https://apnews.com/hub/ap-top-25-mens-college-basketball-poll", apNote=data?.ap?.note||"";
    const kpRank=data?.kenpom?.rank??data?.kenpom_rank??"—", kpMain="https://kenpom.com/", kpTeam="https://kenpom.com/team.php?team=Purdue", kpNote=data?.kenpom?.note||"";
    const updatedTs=data?.updated??data?.ap?.updated??data?.kenpom?.updated??null;
    el.innerHTML=`<div>AP Top 25: <a href="${esc(apUrl)}" target="_blank" rel="noopener">${esc(apRank.toString())}</a>${apNote?` <span class="muted small">(${esc(apNote)})</span>`:""}</div>
                  <div>KenPom: <a href="${esc(kpMain)}" target="_blank" rel="noopener">${esc(kpRank.toString())}</a> <a href="${esc(kpTeam)}" target="_blank" rel="noopener" class="muted small">(team)</a>${kpNote?` <span class="muted small">(${esc(kpNote)})</span>`:""}</div>`;
    stamp.textContent=updatedTs?`Last updated ${fmtUpdated(updatedTs)}`:"";
  }

  /* ---------- Schedule (multi-file tolerant) ---------- */
  function parseISO(d){ const x=new Date(d); return isNaN(x.getTime())?null:x; }
  function formatLocal(dt){
    if(!dt) return "";
    return dt.toLocaleString(undefined,{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:true})+" local";
  }
  function asGames(data){
    if(!data) return [];
    const arr = Array.isArray(data) ? data :
                Array.isArray(data.items) ? data.items :
                Array.isArray(data.games) ? data.games : [];
    return arr.map(g=>{
      const ts = parseTs(g.ts) || parseTs(g.start) || parseTs(g.dateTime||g.datetime) || null;
      const site = g.site || g.homeAway || g.venue_type || g.locationType || "";
      const loc  = g.location || g.arena || g.venue || "";
      const opp  = g.opponent || g.title || g.name || g.opp || "TBD";
      const url  = g.link || g.url || g.tickets || g.gamecast || null;
      return { ts, site, loc, opp, url };
    });
  }
  function gameBlock(g){
    const when = g.ts ? new Date(g.ts<1e12?g.ts*1000:g.ts) : null;
    return `<div class="game">
      <div class="game-title">${esc(g.opp)}</div>
      ${g.site?`<div class="game-sub">${esc(g.site)}</div>`:""}
      ${when?`<div class="game-sub">${formatLocal(when)}</div>`:""}
      ${g.loc?`<div class="game-sub">Location: ${esc(g.loc)}</div>`:""}
      ${g.url?`<div class="game-sub"><a target="_blank" rel="noopener" href="${esc(g.url)}">Game details ↗</a></div>`:""}
    </div>`;
  }
  async function initSchedule(){
    const list=$("#scheduleList"), stamp=$("#schedStamp");
    const raw = await loadFirstExisting([
      "static/data/schedule_overrides.json",
      "static/teams/purdue-mbb/schedule.json",
      "static/data/schedule_compiled.json",
      "static/data/schedule.json"
    ]);
    const games = asGames(raw);
    const now = Date.now();
    const upcoming = games
      .filter(g => g.ts && (g.ts >= now - 3*3600*1000))
      .sort((a,b)=>a.ts - b.ts)
      .slice(0,5);

    if(!upcoming.length){ list.innerHTML=`<div class="muted small">No upcoming games.</div>`; stamp.textContent=""; return; }
    list.innerHTML = upcoming.map(gameBlock).join("");
    stamp.textContent = `Updated ${fmtUpdated(Math.max(...upcoming.map(g=>g.ts)))}`
  }

  /* ---------- Boot ---------- */
  async function boot(){
    await initNews();
    await initRankings();
    await initSchedule();
  }
  (document.readyState==="loading") ? document.addEventListener("DOMContentLoaded", boot, {once:true}) : boot();
  </script>

  <script src="./static/js/pro.js?v=13"></script>
</body>
</html>
