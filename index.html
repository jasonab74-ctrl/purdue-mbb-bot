<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Purdue Boilermakers — Men’s Basketball</title>

  <!-- Icons (use your real files if you have them) -->
  <link rel="icon" href="static/logo.png" type="image/png">

  <link rel="stylesheet" href="static/style.css"/>
</head>
<body>
  <header class="hero">
    <div class="brand">
      <img class="logo" src="static/logo.png" alt="Purdue logo" onerror="this.style.display='none'">
      <div class="titles">
        <h1>Purdue Boilermakers — Men’s Basketball</h1>
        <p class="tagline">Live team feed · auto-updates</p>
      </div>
    </div>

    <div class="fight">
      <button id="fight-btn" class="btn-pill">► Hail Purdue</button>
      <audio id="fight-audio" preload="auto">
        <source src="static/hail-purdue.mp3" type="audio/mpeg"/>
      </audio>
    </div>
  </header>

  <nav class="links" id="quick-links"></nav>

  <section class="toolbar">
    <label for="sourceSel">Source:</label>
    <select id="sourceSel">
      <option value="*">All sources</option>
    </select>

    <div class="updated">
      <span>Updated:</span>
      <time id="updatedTs">—</time>
    </div>
  </section>

  <main id="feed" class="feed"></main>

  <footer class="foot">
    <a class="muted" href="items.json" target="_blank" rel="noopener">items.json</a>
  </footer>

  <script>
    // ---- helpers ----
    const fmtDate = (iso) => {
      try {
        const d = new Date(iso);
        return d.toLocaleString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        });
      } catch { return iso || ''; }
    };

    const byId = (id)=>document.getElementById(id);
    const feedEl = byId('feed');
    const sourceSel = byId('sourceSel');

    // fight song (no bouncing, no new tab)
    const fightBtn = byId('fight-btn');
    const fightAudio = byId('fight-audio');
    fightBtn.addEventListener('click', () => {
      if (fightAudio.paused) {
        fightAudio.currentTime = 0;
        fightAudio.play().catch(()=>{ /* ignore autoplay block */ });
        fightBtn.textContent = '⏸ Hail Purdue';
      } else {
        fightAudio.pause();
        fightBtn.textContent = '► Hail Purdue';
      }
    });

    // ---- render ----
    let DATA = null;

    function renderSources(list) {
      // harden: keep options stable
      const existing = new Set();
      [...sourceSel.options].forEach(opt => existing.add(opt.value));
      list.forEach(name => {
        if (!existing.has(name)) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sourceSel.appendChild(opt);
        }
      });
    }

    function renderLinks(links) {
      const nav = document.getElementById('quick-links');
      nav.innerHTML = '';
      links.forEach(l => {
        const a = document.createElement('a');
        a.className = 'pill';
        a.href = l.url;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = l.label;
        nav.appendChild(a);
      });
    }

    function renderItems(items) {
      const filter = sourceSel.value;
      feedEl.innerHTML = '';
      (items || []).forEach(it => {
        if (filter !== '*' && it.source !== filter) return;

        const card = document.createElement('article');
        card.className = 'card';

        // Only ONE clickable thing: the bold title (no second underlined link)
        const titleA = document.createElement('a');
        titleA.className = 'title';
        titleA.href = it.link;
        titleA.target = '_blank';
        titleA.rel = 'noopener';
        titleA.textContent = it.title;

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${it.source}  •  ${fmtDate(it.published)}`;

        card.appendChild(titleA);
        card.appendChild(meta);
        feedEl.appendChild(card);
      });
    }

    async function load() {
      const res = await fetch('items.json', {cache:'no-cache'});
      const data = await res.json();
      DATA = data;

      // sources + updated
      renderSources(data.sources || []);
      document.getElementById('updatedTs').textContent = fmtDate(data.updated);

      // links row
      renderLinks(data.links || []);

      // items
      renderItems(data.items || []);
    }

    sourceSel.addEventListener('change', () => {
      if (!DATA) return;
      renderItems(DATA.items || []);
    });

    // poll items.json every 5 min without altering layout
    load();
    setInterval(load, 5 * 60 * 1000);
  </script>
</body>
</html>