<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Purdue Boilermakers — Men’s Basketball</title>

  <!-- Icons kept relative so GitHub Pages subfolders work -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#000000" />

  <!-- cache-busted so styles never regress -->
  <link rel="stylesheet" href="static/style.css?v=purdue-static-2025-09-08a" />
</head>
<body>
  <header class="hero">
    <div class="logo-box">
      <img
        src="static/purdue.png"
        alt="Purdue logo"
        width="64"
        height="64"
        onerror="this.onerror=null; this.src='static/logo.png';"
      />
    </div>

    <div class="hero-titles">
      <h1>Purdue Boilermakers — Men’s Basketball</h1>
      <div class="sub">Live team feed · auto-updates (from items.json)</div>
    </div>

    <button id="songBtn" class="song-btn" type="button" title="Hail Purdue">
      ▶ Hail Purdue
    </button>
    <audio id="song" src="static/fight-song.mp3" preload="auto"></audio>
  </header>

  <!-- Quick links (buttons) — rendered from items.json: links[] -->
  <div id="links" class="pill-row"></div>

  <section class="controls">
    <div class="control">
      <label>Source:</label>
      <select id="sourceSelect"></select>
    </div>
    <div class="control right">
      <label>Updated:</label>
      <span id="updated">—</span>
    </div>
  </section>

  <main id="feed"></main>

  <script>
    // ---------- hardened static renderer ----------
    const feedEl = document.getElementById('feed');
    const updatedEl = document.getElementById('updated');
    const sourceSelect = document.getElementById('sourceSelect');
    const linksEl = document.getElementById('links');

    // Fight song (never opens a new tab)
    const song = document.getElementById('song');
    const songBtn = document.getElementById('songBtn');
    songBtn?.addEventListener('click', async () => {
      try{
        if (song.paused) { await song.play(); songBtn.textContent = '⏸ Hail Purdue'; }
        else { song.pause(); song.currentTime=0; songBtn.textContent = '▶ Hail Purdue'; }
      }catch{}
    });

    const fmtLocal = iso => {
      try {
        const d = new Date(iso);
        return d.toLocaleString([], {year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
      } catch { return iso || ''; }
    };

    function renderLinks(links){
      linksEl.innerHTML = '';
      (links||[]).forEach(l=>{
        const label = typeof l === 'string' ? l : (l.label || '');
        const url   = typeof l === 'string' ? '#' : (l.url || '#');
        const a = document.createElement('a');
        a.className = 'pill';
        a.href = url; a.target = '_blank'; a.rel = 'noopener';
        a.textContent = label || url;
        linksEl.appendChild(a);
      });
    }

    function normalizeSourceEntry(s){
      if (typeof s === 'string') return s;
      if (s && typeof s === 'object') return s.label || s.name || s.id || String(s);
      return String(s || '');
    }

    function buildSourceDropdown(items, curated){
      sourceSelect.innerHTML = '';
      const curatedStrings = (Array.isArray(curated)?curated:[]).map(normalizeSourceEntry).filter(Boolean);
      const derived = Array.from(
        new Set((items||[]).map(i => i.source || i.feed).map(normalizeSourceEntry).filter(Boolean))
      ).sort();
      const list = curatedStrings.length ? curatedStrings : derived;

      const optAll = document.createElement('option');
      optAll.value=''; optAll.textContent='All sources';
      sourceSelect.appendChild(optAll);

      list.forEach(label=>{
        const o=document.createElement('option');
        o.value=label; o.textContent=label;
        sourceSelect.appendChild(o);
      });
    }

    function renderItems(items){
      feedEl.innerHTML = '';
      (items||[]).forEach(it=>{
        const card = document.createElement('article');
        card.className = 'card';

        const a = document.createElement('a');
        a.href = it.link; a.target='_blank'; a.rel='noopener';
        a.className='title';
        a.textContent = it.title || '(no title)';

        const meta = document.createElement('div');
        meta.className='meta';
        const srcLabel = normalizeSourceEntry(it.source || it.feed);
        meta.textContent = `${srcLabel} • ${fmtLocal(it.published || it.updated)}`;

        card.appendChild(a);
        card.appendChild(meta);
        feedEl.appendChild(card);
      });
    }

    function applyFilter(all){
      const src = sourceSelect.value;
      const list = src ? all.filter(i => normalizeSourceEntry(i.source || i.feed) === src) : all;
      renderItems(list);
    }

    async function loadAndRender(initial=false){
      try{
        // Static file; no-store stops Safari/Pages caching weirdness
        const r = await fetch('items.json?ts='+Date.now(), {cache:'no-store'});
        const data = await r.json();

        // Always present, so UI never collapses
        renderLinks(data.links || []);
        buildSourceDropdown(data.items || [], data.sources || []);
        updatedEl.textContent = data.updated ? fmtLocal(data.updated) : '—';
        renderItems(data.items || []);

        if (initial) sourceSelect.addEventListener('change', () => applyFilter(data.items || []));
      }catch(e){
        updatedEl.textContent = 'load failed';
      }
    }

    loadAndRender(true);
    // Optional: check for a new items.json every 10 min (safe for static)
    setInterval(() => loadAndRender(false), 10 * 60 * 1000);
  </script>
</body>
</html>