<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Purdue Boilermakers — Men’s Basketball</title>
  <meta name="description" content="Live Purdue men's basketball feed with auto-updates." />

  <!-- Favicon / touch icon (use relative paths so GitHub Pages subpaths work) -->
  <link rel="icon" href="static/logo.png" />
  <link rel="apple-touch-icon" href="static/logo.png" />
  <meta name="apple-mobile-web-app-title" content="Purdue Hoops" />
  <meta name="theme-color" content="#000000" />

  <link rel="stylesheet" href="static/style.css" />
</head>
<body>
  <header class="hero">
    <div class="brand">
      <img src="static/logo.png" alt="Purdue logo" class="brand-logo" />
      <div class="brand-text">
        <h1>Purdue Boilermakers — <span>Men’s Basketball</span></h1>
        <div class="sub">Live team feed · auto-updates</div>
      </div>
    </div>

    <!-- Fight song button; fixed width to avoid “bouncing” -->
    <button id="songBtn" class="pill cta" aria-label="Play Hail Purdue">
      <span class="cta-dot" aria-hidden="true">▶</span>
      Hail Purdue
    </button>

    <!-- The audio lives in /static; use a stable relative path -->
    <audio id="song" preload="auto">
      <source src="static/hail-purdue.mp3" type="audio/mpeg" />
    </audio>
  </header>

  <main class="wrap" id="app">
    <!-- your existing pills/filters/date row -->
    <section id="links" class="links-row"></section>

    <div class="meta-row">
      <label class="meta">Source:</label>
      <select id="sourceSelect" class="select"></select>

      <div class="updated">
        <span>Updated:</span>
        <time id="updatedTs">—</time>
      </div>
    </div>

    <section id="feed" class="feed"></section>
  </main>

  <script>
    // ---- fight song (no new window; no bounce) ----
    (function () {
      const btn = document.getElementById('songBtn');
      const audio = document.getElementById('song');
      let playing = false;

      const setState = (isPlaying) => {
        playing = isPlaying;
        btn.classList.toggle('playing', playing);
        btn.innerHTML = (playing ? '⏸' : '<span class="cta-dot">▶</span>') + ' Hail Purdue';
      };

      btn.addEventListener('click', () => {
        if (!playing) {
          audio.currentTime = 0;
          audio.play().then(() => setState(true))
                      .catch(() => setState(false));
        } else {
          audio.pause();
          setState(false);
        }
      });

      audio.addEventListener('ended', () => setState(false));
      audio.addEventListener('pause', () => setState(false));
      audio.addEventListener('play', () => setState(true));
    })();

    // ---- items.json loader (unchanged; hardened site reads only items.json) ----
    async function load() {
      try {
        const res = await fetch('items.json', { cache: 'no-store' });
        const data = await res.json();

        // Updated timestamp
        document.getElementById('updatedTs').textContent =
          new Date(data.updated).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', month: 'short', day: 'numeric', year: 'numeric' });

        // Links row
        const links = document.getElementById('links');
        links.innerHTML = (data.links || []).map(l => `
          <a class="pill" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>
        `).join('');

        // Source dropdown (stable curated list from items.json)
        const sel = document.getElementById('sourceSelect');
        const sources = ['All sources'].concat(data.sources || []);
        sel.innerHTML = sources.map((s, i) => `<option value="${i === 0 ? '' : s}">${s}</option>`).join('');

        // Feed
        const feed = document.getElementById('feed');
        const render = (list) => {
          feed.innerHTML = list.map(it => `
            <article class="card">
              <a class="card-link" href="${it.link}" target="_blank" rel="noopener">
                <h3 class="card-title">${it.title}</h3>
                <div class="card-meta">
                  <span class="src">${it.source || ''}</span>
                  <span class="dot">•</span>
                  <time class="ts">${new Date(it.published).toLocaleString('en-US')}</time>
                </div>
                ${it.summary ? `<p class="card-sum">${it.summary}</p>` : ``}
              </a>
            </article>
          `).join('');
        };

        render(data.items || []);

        sel.addEventListener('change', () => {
          const v = sel.value;
          if (!v) return render(data.items || []);
          render((data.items || []).filter(it => (it.source || '').toLowerCase() === v.toLowerCase()));
        });
      } catch (e) {
        console.error(e);
      }
    }
    load();
  </script>
</body>
</html>
